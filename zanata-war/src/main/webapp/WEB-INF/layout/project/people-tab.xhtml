<!--
  Copyright 2015, Red Hat, Inc. and individual contributors
  as indicated by the @author tags. See the copyright.txt file in the
  distribution for a full listing of individual contributors.

  This is free software; you can redistribute it and/or modify it
  under the terms of the GNU Lesser General Public License as
  published by the Free Software Foundation; either version 2.1 of
  the License, or (at your option) any later version.

  This software is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public
  License along with this software; if not, write to the Free
  Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
  02110-1301 USA, or see the FSF site: http://www.fsf.org.
  -->
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
        xmlns:s="http://jboss.org/schema/seam/taglib"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:zanata="http://java.sun.com/jsf/composite/zanata"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:a4j="http://richfaces.org/a4j"
        xmlns:rich="http://richfaces.org/rich">

  <div class="panel l--push-top-1">
    <div class="panel__header">
      <div class="panel__header__actions">
        <ui:param name="canManageMembers" value="#{identity.hasPermission(projectHome.instance, 'manage-members')
            or identity.hasPermission(projectHome.instance, 'manage-translation-members')}"/>
        <s:fragment rendered="#{canManageMembers}">
          <button class="button button--primary panel__header__button"
              data-toggle="modal"
              data-target="#modal-add-someone">
            <i class="i i--plus"></i> #{msgs['jsf.people.AddSomeone']}
          </button>
        </s:fragment>

        <zanata:sortlist id="project-people_sorting"
          sortAction="#{projectHomeAction.peopleFilterComparator.sortPeopleList()}"
          render="people_form, peopleSearch-pager, peopleSearch-page-info, peopleSearchBottom-pager, peopleSearchBottom-page-info"
          oncomplete="refreshTooltip('#{rich:clientId('people_form')}')"
          sortingList="#{projectHomeAction.peopleSortingList}"
          onbegin="clearHTML('#{rich:clientId('people_form')}')"
          status="peopleTab-peopleLoader"/>

        <!-- TODO this needs a bunch of params to customize it -->
        <ui:decorate template="person-permissions-modal.xhtml">
          <ui:param name="id" value="modal-add-someone"/>
          <ui:param name="title" value="#{msgs['jsf.people.AddSomeone']}"/>

          <!-- TODO use different field for this -->
          <ui:param name="memberships" value="#{projectHomeAction.permissionDialogData}"/>
          <!-- this property will allow the dialog to show the correct
               starting permissions, and will be the value used when the
               dialog is submitted.
               Need to retrieve a PersonProjectMemberships from projectHome
               representing the correct person. -->
          <!-- use ui:define, access in template as <ui:insert name="definedName"/>-->
          <ui:define name="testDefine">
            <p>Then just some content goes in here</p>
          </ui:define>
        </ui:decorate>
      </div>
      <h2 class="panel__heading">#{msgs['jsf.People']}</h2>
    </div>

    <div class="panel__sub-header js-reveal">
      <zanata:list-filter status="peopleTab-peopleLoader"
        listId="people_form" iconClass="i--users"
        render="people_form, peopleSearchBottom-pager, peopleSearchBottom-page-info"
        id="peopleSearch"
        placeholder="#{msgs['jsf.people.SearchPlaceholder']}"
        actionBean="#{projectHomeAction.peopleFilterComparator}"/>
    </div>

    <a4j:status name="peopleTab-peopleLoader">
      <f:facet name="start">
        <zanata:loader/>
      </f:facet>
    </a4j:status>

    <h:form id="people_form" styleClass="l--push-bottom-1">

      <s:div styleClass="l--pad-all-half"
        rendered="#{empty projectHomeAction.allMembers}">
        <p class="txt--meta">#{msgs['jsf.NoPeople']}</p>
        <s:fragment rendered="#{canManageMembers}">
          <p>
            <button class="button button--primary"
              data-toggle="modal"
              data-target="#modal-add-someone">
              <i class="i i--plus"></i> #{msgs['jsf.people.AddSomeone']}
            </button>
          </p>
        </s:fragment>
      </s:div>

      <s:fragment rendered="#{not projectHomeAction.peopleFilterComparator.isShowMembersInGroup()}">
        <s:div styleClass="l--pad-all-half"
          rendered="#{not empty projectHomeAction.allMembers and empty projectHomeAction.peopleFilterComparator.currentPage}">
          <p class="txt--meta">#{msgs['jsf.search.NoResult']}</p>
        </s:div>

        <s:fragment
          rendered="#{!projectHomeAction.peopleFilterComparator.currentPage.isEmpty()}">
          <ul class="list--slat l--push-all-half">
            <ui:repeat value="#{projectHomeAction.peopleFilterComparator.currentPage}" var="person">
              <zanata:people-entry person="#{person}"
                canManageMembers="#{canManageMembers}"
                managePermissionsRender="modal-manage-permissions"
                managePermissionsModal="modal-manage-permissions-content"/>
            </ui:repeat>
          </ul>
        </s:fragment>
      </s:fragment>

      <s:fragment rendered="#{projectHomeAction.peopleFilterComparator.isShowMembersInGroup()}">
        <ui:param name="maintainers" value="#{projectHomeAction.peopleFilterComparator.getMaintainers()}"/>
        <ui:param name="translators" value="#{projectHomeAction.peopleFilterComparator.getTranslators()}"/>

        <s:div styleClass="l--pad-all-half"
          rendered="#{not empty projectHomeAction.allMembers and empty maintainers and empty translators}">
          <p class="txt--meta">#{msgs['jsf.search.NoResult']}</p>
        </s:div>

        <s:div styleClass="l--pad-h-half l--push-bottom-1" rendered="#{not empty maintainers}">
          <h3 class="heading--secondary l--push-bottom-quarter">
            #{msgs['jsf.project.peoplelist.project.label']}
            <span class="txt--mini l--push-left-quarter">
              <span class="badge">#{maintainers.size}</span>
            </span>
          </h3>
          <ul class="list--slat">
            <ui:repeat value="#{maintainers}" var="person">
              <zanata:people-entry person="#{person}"
                canManageMembers="#{canManageMembers}"
                managePermissionsRender="modal-manage-permissions"
                managePermissionsModal="modal-manage-permissions-content"/>
            </ui:repeat>
          </ul>
        </s:div>

        <s:div styleClass="l--pad-h-half" rendered="#{not empty translators}">
          <h3 class="heading--secondary l--push-bottom-quarter">
            #{msgs['jsf.project.peoplelist.translation.label']}
            <span class="txt--mini l--push-left-quarter">
              <span class="badge">#{translators.size}</span>
            </span>
          </h3>
          <ui:repeat value="#{translators.entrySet().toArray()}" var="entry">
            <h4 class="heading--sub delta">
              #{entry.key.retrieveDisplayName()}
              <span class="txt--mini l--push-left-quarter">
                <span class="badge">#{entry.value.size}</span>
              </span>
            </h4>
            <ul class="list--slat l--push-bottom-1">
              <ui:repeat value="#{entry.value.entrySet().toArray()}" var="personEntry">
                <zanata:people-entry person="#{personEntry.key}"
                  canManageMembers="#{canManageMembers}"
                  managePermissionsRender="modal-manage-permissions"
                  managePermissionsModal="modal-manage-permissions-content"/>
              </ui:repeat>
            </ul>
            <!-- loop through all locale in project -->
            <!-- is person is in locale, display -->
          </ui:repeat>
        </s:div>
      </s:fragment>
    </h:form>
    <zanata:list-filter status="peopleTab-peopleLoader"
      listId="people_form" iconClass="i--users"
      render="people_form, peopleSearch-pager, peopleSearch-page-info"
      id="peopleSearchBottom" bottomPanel="true"
      placeholder="#{msgs['jsf.people.SearchPlaceholder']}"
      actionBean="#{projectHomeAction.peopleFilterComparator}"/>
  </div>

  <s:div id="modal-manage-permissions">
    <div class="modal" id="modal-manage-permissions-content" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal__dialog l--constrain-medium">
        <header class="modal__header">
          <h2 class="modal__title">#{msgs['jsf.projectPermissions.ManagePermissions']}</h2>
          <button class="modal__close button--link" data-dismiss="modal">
            <i class="i i--huge i--cancel"></i>
          </button>
        </header>
        <div class="modal__content">
          <h:form>
            <div class="l--pad-all-1">
              <ui:remove>
                <!-- TODO custom user selection mechanism -->
                <h3 class="l--push-top-0">#{msgs['jsf.people.SelectUser']}</h3>
                <label for="add-person-user" class="is-invisible">#{msgs['jsf.User']}</label>
                <input type="text" id="add-person-user" placeholder="Search name or username"/>
              </ui:remove>

              <p class="txt--lead">
                <zanata:person-tile person="#{projectHomeAction.permissionDialogData.person}"/>
                <ui:remove>
                  <button class="button button--link link--neutral bx--inline-block l--pad-v-quarter"
                      title="#{msgs['jsf.people.RemoveUser']}">
                    <i class="i i--small i--cross"></i>
                    <span class="is-sr-only">#{msgs['jsf.people.RemoveUser']}</span>
                  </button>
                </ui:remove>
              </p>

              <hr/>

              <h3>#{msgs['jsf.ProjectPermissions']}</h3>
              <div class="g--tight">
                <div class="g__item w--1-3">
                  <label class="l--push-bottom-0">
                    #{msgs['jsf.ProjectPermissions']}</label>
                </div>
                <div class="g__item w--2-3">
                  <ul id="modal-manage-permissions-project-permissions"
                      class="list--horizontal">
                    <li>
                      <zanata:checkbox
                          label="#{msgs['jsf.projectPermissions.ManageTranslators']}"
                          labelStyle="form__checkbox__label js-form__checkbox__label"
                          checked="#{projectHomeAction.permissionDialogData.translationMaintainer}"
                          onValueChanged="bindProjectPermissionRole"
                          value="TranslationMaintainer"/>
                    </li>
                    <li>
                      <zanata:checkbox
                          label="#{msgs['jsf.projectPermissions.MaintainProject']}"
                          labelStyle="form__checkbox__label js-form__checkbox__label"
                          checked="#{projectHomeAction.permissionDialogData.maintainer}"
                          onValueChanged="bindProjectPermissionRole"
                          value="Maintainer"/>
                    </li>
                  </ul>

                    <s:fragment rendered="#{!identity.hasPermission(projectHome.instance, 'manage-members')}">
                      <p class="txt--meta l--push-top-half">
                        #{msgs['jsf.projectPermissions.YouCannotModify']}
                      </p>
                    </s:fragment>

                    <!-- TODO set username, and change text depending on selection -->
                    <!--<p class="txt- -meta l- -push-top-half">-->
                    <!--<strong>djansen</strong> will be able to add/remove translators-->
                    <!--and reviewers to any language as well as translate or review any-->
                    <!--language. They are not able to change project settings.-->
                    <!--</p>-->
                </div>
              </div>

              <hr/>

              <h3>Translation Permissions</h3>
              <s:fragment rendered="#{empty projectHomeAction.permissionDialogData.localeRoles.toArray()}">
                  <p>#{msgs['jsf.languages.NoLanguagesEnabled']}</p>
              </s:fragment>
              <ul class="list--slat">
                <!-- TODO add filtering for list -->
                <ui:repeat value="#{projectHomeAction.permissionDialogData.localeRoles.toArray()}" var="roles">
                  <li>
                    <div class="g--tight">
                      <div class="g__item w--1-3">
                        <label class="l--push-bottom-0">
                          #{roles.locale.retrieveDisplayName()}
                        </label>
                      </div>
                      <div class="g__item w--2-3">
                        <ul class="list--horizontal">
                          <li>
                            <zanata:checkbox
                                label="Translate"
                                labelStyle="form__checkbox__label js-form__checkbox__label"
                                onValueChanged="bindTranslationPermissionRole"
                                value="#{roles.locale.localeId}:Translator"
                                checked="#{roles.translator}"/>
                          </li>
                          <li>
                            <zanata:checkbox
                                label="Review"
                                labelStyle="form__checkbox__label js-form__checkbox__label"
                                onValueChanged="bindTranslationPermissionRole"
                                value="#{roles.locale.localeId}:Reviewer"
                                checked="#{roles.reviewer}"/>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </li>
                </ui:repeat>
              </ul>
            </div>
            <div class="modal__footer l--pad-h-1 l--pad-v-half bg--highest txt--align-right">
              <button onclick="return false;" class="button--link h--1-1-4 l--push-right-half" data-dismiss="modal">
                #{msgs['jsf.Cancel']}</button>

              <h:panelGroup id="modal-manage-permissions-submit-buttons">
                <a4j:commandButton value="Save permissions"
                    rendered="#{projectHomeAction.anyPermissionsSelected()}"
                    onclick="savePermissionDialog();zanata.modal.hide(jQuery('#modal-manage-permissions-content'));return false;">
                </a4j:commandButton>
                <a4j:commandButton value="Remove person from project"
                    rendered="#{not projectHomeAction.anyPermissionsSelected()}"
                    onclick="savePermissionDialog();zanata.modal.hide(jQuery('#modal-manage-permissions-content'));return false;">
                </a4j:commandButton>
              </h:panelGroup>
            </div>
          </h:form>
        </div>
      </div>
      <script type="text/javascript">
        //<![CDATA[
        zanata.form.appendCheckboxes(jQuery('#modal-manage-permissions-content').element);
        //]]>
      </script>
      <s:fragment rendered="#{!identity.hasPermission(projectHome.instance, 'manage-members')}">
        <script type="text/javascript">
          //<![CDATA[
          jQuery('#modal-manage-permissions-project-permissions')
            .find(' input')
            .trigger('disable');
          //]]>
        </script>
      </s:fragment>
    </div>
  </s:div>

</ui:composition>
