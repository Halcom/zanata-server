<!--
  Copyright 2015, Red Hat, Inc. and individual contributors
  as indicated by the @author tags. See the copyright.txt file in the
  distribution for a full listing of individual contributors.

  This is free software; you can redistribute it and/or modify it
  under the terms of the GNU Lesser General Public License as
  published by the Free Software Foundation; either version 2.1 of
  the License, or (at your option) any later version.

  This software is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public
  License along with this software; if not, write to the Free
  Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
  02110-1301 USA, or see the FSF site: http://www.fsf.org.
  -->
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
        xmlns:s="http://jboss.org/schema/seam/taglib"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:zanata="http://java.sun.com/jsf/composite/zanata"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:a4j="http://richfaces.org/a4j"
        xmlns:rich="http://richfaces.org/rich">

  <div class="panel l--push-top-1">
    <div class="panel__header">
      <div class="panel__header__actions">
        <s:fragment rendered="#{s:hasPermission(projectHome.instance, 'manage-members')
            or s:hasPermission(projectHome.instance, 'manage-translation-members')}">
          <button class="button button--primary panel__header__button"
              data-toggle="modal"
              data-target="#modal-add-someone">
            <i class="i i--plus"></i> #{msgs['jsf.people.AddSomeone']}
          </button>
        </s:fragment>

        <zanata:sortlist id="project-people_sorting"
          sortAction="#{projectHome.peopleFilter.sortPeopleList()}"
          render="people_form, peopleSearch-pager, peopleSearch-page-info, peopleSearchBottom-pager, peopleSearchBottom-page-info"
          oncomplete="refreshTooltip('#{rich:clientId('people_form')}')"
          sortingList="#{projectHome.peopleSortingList}"
          onbegin="clearHTML('#{rich:clientId('people_form')}')"
          status="peopleTab-peopleLoader"/>

        <!-- TODO this needs a bunch of params to customize it -->
        <ui:decorate template="person-permissions-modal.xhtml">
          <ui:param name="id" value="modal-add-someone"/>
          <ui:param name="title" value="#{msgs['jsf.people.AddSomeone']}"/>

          <!-- TODO use different field for this -->
          <ui:param name="memberships" value="#{projectHome.permissionDialogData}"/>
          <!-- this property will allow the dialog to show the correct
               starting permissions, and will be the value used when the
               dialog is submitted.
               Need to retrieve a PersonProjectMemberships from projectHome
               representing the correct person. -->
          <!-- use ui:define, access in template as <ui:insert name="definedName"/>-->
          <ui:define name="testDefine">
            <p>Then just some content goes in here</p>
          </ui:define>
        </ui:decorate>

        <ui:decorate template="person-permissions-modal.xhtml">
          <ui:param name="id" value="modal-manage-permissions"/>
          <ui:param name="title" value="#{msgs['jsf.projectPermissions.ManagePermissions']}"/>

          <ui:param name="memberships" value="#{projectHome.permissionDialogData}"/>
          <!-- this property will allow the dialog to show the correct
               starting permissions, and will be the value used when the
               dialog is submitted.
               Need to retrieve a PersonProjectMemberships from projectHome
               representing the correct person. -->
          <!-- use ui:define, access in template as <ui:insert name="definedName"/>-->
          <ui:define name="testDefine">
            <p>Then just some content goes in here</p>
          </ui:define>
          </ui:decorate>




      </div>

      <h2 class="panel__heading">#{msgs['jsf.People']}</h2>
    </div>

    <div class="panel__sub-header js-reveal">
      <zanata:list-filter status="peopleTab-peopleLoader"
        listId="people_form" iconClass="i--users"
        render="people_form, peopleSearchBottom-pager, peopleSearchBottom-page-info"
        id="peopleSearch"
        placeholder="#{msgs['jsf.people.SearchPlaceholder']}"
        actionBean="#{projectHome.peopleFilter}"/>
    </div>

    <a4j:status name="peopleTab-peopleLoader">
      <f:facet name="start">
        <zanata:loader/>
      </f:facet>
    </a4j:status>

    <h:form id="people_form" styleClass="l--push-bottom-1">

      <s:div styleClass="l--pad-all-half"
        rendered="#{empty projectHome.allMembers}">
        <p class="txt--meta">#{msgs['jsf.NoPeople']}</p>
        <s:fragment
          rendered="#{s:hasPermission(projectHome.instance, 'manage-members')
            or s:hasPermission(projectHome.instance, 'manage-translation-members')}">
          <p>
            <button class="button button--primary"
              data-toggle="modal"
              data-target="#modal-add-someone">
              <i class="i i--plus"></i> #{msgs['jsf.people.AddSomeone']}
            </button>
          </p>
        </s:fragment>
      </s:div>

      <s:div styleClass="l--pad-all-half"
        rendered="#{not empty projectHome.allMembers and empty projectHome.peopleFilter.currentPage}">
        <p class="txt--meta">#{msgs['jsf.search.NoResult']}</p>
      </s:div>

      <s:fragment
        rendered="#{!projectHome.peopleFilter.currentPage.isEmpty()}">
        <ul class="list--slat l--push-all-half">
          <ui:repeat value="#{projectHome.peopleFilter.currentPage}" var="person">
            <li>
              <div class="g g--tighter">
                <div class="g__item w--4-12">
                  <!-- TODO use a component for a person avatar + name + profile link -->
                  <a href="#{request.contextPath}/profile/view/#{person.account.username}">
                    <span class="w--r-1 bx--round l--push-right-quarter">
                      <img src="#{gravatarServiceImpl.getUserImageUrl(48, person.email)}" alt=""/>
                    </span>
                      #{person.account.username}
                  </a>
                </div>
                <div class="g__item w--4-12">
                  <ui:repeat value="#{projectHome.memberRoles.get(person).toArray()}" var="role">
                    <div class="txt--understated">#{projectHome.projectRoleDisplayName(role)}</div>
                  </ui:repeat>
                </div>
                <div class="g__item w--4-12 txt--align-right">
                  <s:fragment
                      rendered="#{s:hasPermission(projectHome.instance, 'manage-members')
                               or s:hasPermission(projectHome.instance, 'manage-translation-members')}">
                    <!-- TODO does this need its own dialog, or can it reuse the other?
                      Differences:
                        - different title
                        - hard-coded person
                        - different submit button text
                        - different button state+text when nothing selected

                      Similarities:
                        - single person selected (may change later)
                        - available permissions identical
                        - display current permissions when user selected
                        - permission check for each section is the same
                    -->
                    <!-- TODO onclick -> set person for permission dialog -->
                    <button class="button button--small"
                            data-toggle="modal"
                            data-target="#modal-manage-permissions">
                      <i class="i i--settings"></i>
                      #{msgs['jsf.projectPermissions.ManagePermissions']}
                    </button>
                  </s:fragment>
                </div>
              </div>
            </li>
          </ui:repeat>
        </ul>
      </s:fragment>
    </h:form>
    <zanata:list-filter status="peopleTab-peopleLoader"
      listId="people_form" iconClass="i--users"
      render="people_form, peopleSearch-pager, peopleSearch-page-info"
      id="peopleSearchBottom" bottomPanel="true"
      placeholder="#{msgs['jsf.people.SearchPlaceholder']}"
      actionBean="#{projectHome.peopleFilter}"/>
  </div>

</ui:composition>
